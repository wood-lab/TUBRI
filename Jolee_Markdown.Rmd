---
title: "Jolee_Markdown"
author: "Jolee Thirtyacre, Connor Whalen"
date: "2024-07-17"
output:
  html_document:
    theme: readable
    highlight: textmate
    toc: true
    toc_float: true
    toc_depth: 3
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

### General instructions for R Markdown
* For helpful instructions on how to start using R Markdown, visit [this link] (https://fish497.github.io/website/lectures/week_07/intro_rmarkdown.html).
* To insert code chunks, press command+option+i (mac), ctrl+alt+i (windows)
* Anything inside a code chunk will run as normal code, anything outside a code chunk will appear in the document as plain text. 


## Questions we are asking: 
1. Is increased parasitism associated with decreased body condition?
* This is complicated because we are proposing an observational study and the causality that we are attempting to describe can go in both directions. Fish that have high parasitism could be skinner, but also skinner fish could be more susceptible to increased parasitism. We won’t be able to parse this out using our dataset, but it is still an interesting question worth answering. We just need to be careful to not make any absolute statements based on this (which is why we use the language ‘associated’ instead of ‘affected by’). 
* There is the element of time that we can incorporate into this as well, which is to say that we could look at body condition over time and see what trends exist. If there are any non-linear trends in body condition through time (meaning it doesn’t just go down or just go up or just stay the same), we can then incorporate the variable of parasite presence/burden to see if there is any correlation between the non-linear changes in body condition and parasite counts. This would basically look like on a graph, you have a big drop in body size followed a period of time later by an increase in parasite presence in these fish, you could say something like skinnier fish are associated with an increased parasite burden, since we would see that some event caused body size to decrease and as a result there was more parasites in the fish. But again we have to be really careful to not imply causation if all we have is correlation. Chelsea said she would be surprised if we noticed this effect, but it could be worth looking at anyway. 
2. Is the type of parasite important in determining whether parasitism is associated with decreased body condition?
* Parasites exist in different parts of the body based on what they are: monogenes will always be on the gills, adult trematodes and adult cestodes will always be in the intestines, metacercariae can be most anywhere on the body, etc. 
* To answer this question, we would need to go through the data and identify what parasites are in their adult stage versus their larval stage. This would involve a bit of research into what the different (larval or adult) stages are present for each of the ones we have found. You would then be also able to look at the literature to see where that parasite would live within the fish at that stage in its life cycle, and then we could make commentaries about how different stages/types of parasites could be associated with changes to body condition. For example, if we had a ton of adult cestodes in the intestine and found that fish to have a very bad condition score, we could talk about how adult cestodes require more nutrients based on their big size, etc. 

## Methods
We removed "one-off" species as defined by appearing less than five times across all species datasets and if the parasite also exists in its own group (e.g., We found four acanthacephalean species across four fish species, so acanths were removed because less than five were found and they exist in a seperate group from other parasites. e.g., TREM.META was kept because even though it only appeared once in the H. nuchalis dataset, it will be lumped in with the other trematode metacercaria data points.)

#### Rules for discriminating between adult and larval: 
* For any parasite we have identified to a specific taxonomic level (family, genus, etc.), we will look at that life cycle in the literature and ID what stage we have. 
* Anything labeled as META or CYST are considered larval, as metacercaria and cysts are by definition non-final adult forms of parasites.  
* Anything labeled as TREM, NEM, ACANTH, MONO, COPE, or CEST are considered adults of those groups, as we were able to ID them to larger taxonomic groups because they were not in cysts. 
* lists in the code below are the complete lists of which parasites are considered adult or larval

#### Fulton's Condition Factor Equation:
| Variable | Definition                                  |
|----------|---------------------------------------------|
| K        | Fulton's Condition Factor (<1=good, >1=bad) |
| W        | weight of host fish (in grams)              |
| SL       | standard length of fish (in millimeters)    |
$$
K = W/SL^3 *100
$$

## Code for Analyses

#### Install packages
```{r install packages, eval=FALSE, echo=FALSE}
install.packages("tidyverse")
install.packages("janitor")
install.packages("ggeffects")
install.packages("rmarkdown")
install.packages("caret")
install.packages("tibble")
install.packages("lmerTest")
install.packages("DHARMa")
```

#### Load packages
```{r load packages, echo=TRUE}
library(ggeffects)
library(tidyverse)
library(lmerTest)
library(ggpubr)
library(stringr)
library(caret)
library(tibble)
library(car)
library(readr)
library(dbplyr)
library(lubridate)
library(ggplot2)
library(glmmTMB)
library(DHARMa)
```

#### Load datasets 
```{r CW datasets, echo=FALSE}
P.vigilax.data <- read.csv("data/processed/Pimephales_vigilax_processed_human_readable_UPDATED_2024.07.10.csv") %>% janitor::clean_names()
I.punctatus.data <- read.csv("data/processed/Ictalurus_punctatus_processed_human_readable.csv_UPDATED_2024.07.19.csv")  %>%
  janitor::clean_names() %>%
  mutate(day_collected = as.integer(day_collected))
N.atherinoides.data <- read.csv("data/processed/Notropis_atherinoides_processed_human_readable.csv") %>% 
  janitor::clean_names()
H.nuchalis.data <- read_csv("data/processed/Hybognathus_nuchalis_processed_human_readable.csv") %>%
  janitor::clean_names()
```

#### Mutate character variable to numeric for Hnuc
```{r convert to numeric}
H.nuchalis.data <- H.nuchalis.data %>%
  mutate(weight_mg = as.numeric(weight_mg))
```

### Giving adult and larval IDs so we can look at life stage compared to total parasite burden (for answering question 1)
- add columns to identify species as an adult or larval stage and new column for total parasite count
```{r p.vig a/l stage}
Pvig.life.stage.total <- P.vigilax.data %>%
  mutate(adult = rowSums(select(., 
                      "acanth_bigb", 
                      "acanth_bkr",
                      "nem_cona",
                      "nem_cap",
                      "nem_dich",
                      "nem_larv",
                      "nem_trbk",
                      "nem_unk",
                      "cest_godz",
                      "cest_comp",
                      "cest_ntg",
                      "cope_cl",
                      "cope_grab",
                      "cest_pea",
                      "cest_l",
                      "cest_vit",
                      "cest_unk",
                      "mono_gyro",
                      "mono_dact",
                      "mono_lg",
                      "trem_rnda",
                      "trem_unk"))) %>%
  mutate(larval = rowSums(select(.,
                      "meta_hs",
                      "meta_unk", 
                      "myx_go",
                      "myx_geom",
                      "myxo_bc",
                      "myx_thel",
                      "myxo_sbad",
                      "myxo_unk",
                      "myxo_up",
                      "trem_met",
                      "trem_sss",
                      "trem_buc",
                      "trem_metaf",
                      "trem_metags",
                      "trem_ms",
                      "trem_nea"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>%
  janitor::clean_names()

####
Ipun.life.stage.total <- I.punctatus.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_cyst",
                      "trem_meta_gg",
                      "trem_meta_unk",
                      "trem_lg",
                      "nem_cyst",
                      "myx_tail",
                      "myx_geom"))) %>%
  mutate(adult = rowSums(select(.,
                      "acan_ostr",
                      "cest_comp",
                      "cest_meg",
                      "leech_kut",
                      "nem_nmts",
                      "mono_ip",
                      "mono_unk",
                      "nem_phar",
                      "nem_pty",
                      "nem_sp",
                      "nem_taf",
                      "nem_unk",
                      "nmorph",
                      "trem_2",
                      "trem_allo",
                      "trem_ble",
                      "trem_crep",
                      "trem_f",
                      "trem_lip",
                      "trem_megict",
                      "trem_smile",
                      "trem_unk"))) %>%
  select(-nmorph, -leech_kut) %>% 
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>%
  janitor::clean_names()

####
Nath.life.stage.total <- N.atherinoides.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_cyst",
                      "trem_larv",
                      "trem_meta",
                      "myx_sp", 
                      "myx_round",
                      "trem_cyst"))) %>%#
  mutate(adult = rowSums(select(.,
                      "cest_comp",
                      "cest_hyd",
                      "cest_lvs",
                      "cest_tri",
                      "cope_a",
                      "mono_all",
                      "mono_unk",
                      "nem_bran",
                      "nem_cap",
                      "nem_spky",
                      "nem_tfs",
                      "nem_twas",
                      "nem_unkn",
                      "trem_gb",
                      "trem_l"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>%
  janitor::clean_names()

####
Hnuc.life.stage.total <- H.nuchalis.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_daft",
                      "trem_cm",
                      "trem_meta_het",
                      "trem_meta_sp",
                      "trem_bc",
                      "trem_meta_go",
                      "trem_meta_es",
                      "meta_unk",
                      "trem_meta",
                      "trem_meta_unk",
                      "myx_ak",
                      "myx_fi",
                      "myx_tin",
                      "myx_gl",
                      "myx_ot",
                      "myx_eye",
                      "myx_gc"))) %>%#
  mutate(adult = rowSums(select(.,
                      "cest_bb",
                      "nem_bud",
                      "nem_unk",
                      "trem_ass",
                      "trem_ns",
                      "trem_diplo",
                      "trem_unk",
                      "cest_unk",
                      "mono_dact",
                      "mono_gdac",
                      "acan_ad",
                      "cope_pood"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>%
  janitor::clean_names()
```

### Modify datasets to refect only parasites that are able to occur in larval and adult stages in the host. 
- we are doing this because in order to have a truly comparable dataset of parasites and their association with host body condition, we need to analyze parasites in a uniform way that does not skew the data one direction or another. For example, if you look at trematode parasites, both metacercaria and adult trematodes can live within a fish host. Now, compare that to monogenes who only occur as adults in the fish host. Because their larval stage will not occur in these fish hosts, by including them in our analyses we will be skewing the adult subset of parasites high. The monogenes have no larval counterpart in the fish, so they will always push the adult count higher. By removing monogenes from our analyses, we will have an even ground to compare larval and adult parasites. Therefore, parasites to __NOT__ include in our analyses are: 
- monogenes
- copepods
- acanthocephalans
- myxozoans

#### Mutate the data to remove the above-listed parasite groups from the analyses (for answering question 2). 
```{r remove groups, echo=TRUE}
####
Pvig.life.stage.pared <- P.vigilax.data %>%
  mutate(adult = rowSums(select(., 
                      "acanth_bigb", 
                      "acanth_bkr",
                      "nem_cona",
                      "nem_cap",
                      "nem_dich",
                      "nem_larv",
                      "nem_trbk",
                      "nem_unk",
                      "cest_godz",
                      "cest_comp",
                      "cest_ntg",
                      "cope_cl",
                      "cope_grab",
                      "cest_pea",
                      "cest_l",
                      "cest_vit",
                      "cest_unk",
                      "mono_gyro",
                      "mono_dact",
                      "mono_lg",
                      "trem_rnda",
                      "trem_unk"))) %>%
  mutate(larval = rowSums(select(.,
                      "meta_hs",
                      "meta_unk", 
                      "myx_go",
                      "myx_geom",
                      "myxo_bc",
                      "myx_thel",
                      "myxo_sbad",
                      "myxo_unk",
                      "myxo_up",
                      "trem_met",
                      "trem_sss",
                      "trem_buc",
                      "trem_metaf",
                      "trem_metags",
                      "trem_ms",
                      "trem_nea"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>% 
  select(-matches("^(myx_|myxo_|acanth_|mono_|cope_)")) %>% 
  janitor::clean_names()

####
Ipun.life.stage.pared <- I.punctatus.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_cyst",
                      "trem_meta_gg",
                      "trem_meta_unk",
                      "trem_lg",
                      "nem_cyst",
                      "myx_tail",
                      "myx_geom"))) %>%
  mutate(adult = rowSums(select(.,
                      "acan_ostr",
                      "cest_comp",
                      "cest_meg",
                      "leech_kut",
                      "nem_nmts",
                      "mono_ip",
                      "mono_unk",
                      "nem_phar",
                      "nem_pty",
                      "nem_sp",
                      "nem_taf",
                      "nem_unk",
                      "nmorph",
                      "trem_2",
                      "trem_allo",
                      "trem_ble",
                      "trem_crep",
                      "trem_f",
                      "trem_lip",
                      "trem_megict",
                      "trem_smile",
                      "trem_unk"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>% 
  select(-matches("^(myx_|acan_|mono_|leech_|nmorph)")) %>%
  janitor::clean_names()

#### 
Nath.life.stage.pared <- N.atherinoides.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_cyst",
                      "trem_larv",
                      "trem_meta",
                      "myx_sp", 
                      "myx_round",
                      "trem_cyst"))) %>%#
  mutate(adult = rowSums(select(.,
                      "cest_comp",
                      "cest_hyd",
                      "cest_lvs",
                      "cest_tri",
                      "cope_a",
                      "mono_all",
                      "mono_unk",
                      "nem_bran",
                      "nem_cap",
                      "nem_spky",
                      "nem_tfs",
                      "nem_twas",
                      "nem_unkn",
                      "trem_gb",
                      "trem_l"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>% 
  select(-matches("^(myx_|mono_|cope_)")) %>%
  janitor::clean_names()

####
Hnuc.life.stage.pared <- H.nuchalis.data %>%
  mutate(larval = rowSums(select(., 
                      "nem_daft",
                      "trem_cm",
                      "trem_meta_het",
                      "trem_meta_sp",
                      "trem_bc",
                      "trem_meta_go",
                      "trem_meta_es",
                      "meta_unk",
                      "trem_meta",
                      "trem_meta_unk",
                      "myx_ak",
                      "myx_fi",
                      "myx_tin",
                      "myx_gl",
                      "myx_ot",
                      "myx_eye",
                      "myx_gc"))) %>%#
  mutate(adult = rowSums(select(.,
                      "cest_bb",
                      "nem_bud",
                      "nem_unk",
                      "trem_ass",
                      "trem_ns",
                      "trem_diplo",
                      "trem_unk",
                      "cest_unk",
                      "mono_dact",
                      "mono_gdac",
                      "acan_ad",
                      "cope_pood"))) %>%
  mutate(adult = as.integer(adult)) %>% 
  mutate(larval = as.integer(larval)) %>%
  mutate(psite_count = rowSums(select(.,
                                      "adult", 
                                      "larval"))) %>% 
  select(-matches("^(myx_|mono_|cope_|acan_)")) %>%
  janitor::clean_names()
```

### Calculating Fulton's Condition Factor
```{r FCF calculated, echo=TRUE}
### For answering question 1

Nath.life.stage.total <- Nath.life.stage.total %>%
  mutate(body.index.ath = ((Nath.life.stage.total$weight_mg/((Nath.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Pvig.life.stage.total <- Pvig.life.stage.total %>%
  mutate(body.index.vig = ((Pvig.life.stage.total$weight_mg/((Pvig.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Ipun.life.stage.total <- Ipun.life.stage.total %>%
  mutate(body.index.pun = ((Ipun.life.stage.total$weight_mg/((Ipun.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Hnuc.life.stage.total <- Hnuc.life.stage.total %>%
  mutate(body.index.nuc = ((Hnuc.life.stage.total$weight_mg/((Hnuc.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

### For answering question 2

Nath.life.stage.pared <- Nath.life.stage.pared %>%
  mutate(body.index.ath = ((Nath.life.stage.pared$weight_mg/((Nath.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Pvig.life.stage.pared <- Pvig.life.stage.pared %>%
  mutate(body.index.vig = ((Pvig.life.stage.pared$weight_mg/((Pvig.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Ipun.life.stage.pared <- Ipun.life.stage.pared %>%
  mutate(body.index.pun = ((Ipun.life.stage.pared$weight_mg/((Ipun.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

Hnuc.life.stage.pared <- Hnuc.life.stage.pared %>%
  mutate(body.index.nuc = ((Hnuc.life.stage.pared$weight_mg/((Hnuc.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

```

### Combine datasets and scale data. Add condition factor back into the dataframes. 
```{r scaling datasets to each other, echo=FALSE}
### for answering question 1

na_ip_pv_hn_combined.total <- bind_rows(Nath.life.stage.total, Pvig.life.stage.total, Ipun.life.stage.total, Hnuc.life.stage.total, .id = "dataset")
na_ip_pv_hn_pp.total <- preProcess(na_ip_pv_hn_combined.total, method = c("center", "scale"))
na_ip_pv_hn_scaled.total <- predict(na_ip_pv_hn_pp.total, na_ip_pv_hn_combined.total)
notath_scaled.total <- na_ip_pv_hn_scaled.total%>% filter(dataset == "1") %>%
  mutate(body.index.notath = ((Nath.life.stage.total$weight_mg/((Nath.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
pimvig_scaled.total <- na_ip_pv_hn_scaled.total %>% filter(dataset == "2") %>%
  mutate(body.index.pimvig = ((Pvig.life.stage.total$weight_mg/((Pvig.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
ictpun_scaled.total <- na_ip_pv_hn_scaled.total %>% filter(dataset == "3") %>%
  mutate(body.index.ictpun = ((Ipun.life.stage.total$weight_mg/((Ipun.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
hybnuc_scaled.total <- na_ip_pv_hn_scaled.total %>% filter(dataset == "4") %>%
  mutate(body.index.hybnuc = ((Hnuc.life.stage.total$weight_mg/((Hnuc.life.stage.total$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()

### for answering question 2

na_ip_pv_hn_combined.pared <- bind_rows(Nath.life.stage.pared, Pvig.life.stage.pared, Ipun.life.stage.pared, Hnuc.life.stage.pared, .id = "dataset")
na_ip_pv_hn_pp.pared <- preProcess(na_ip_pv_hn_combined.pared, method = c("center", "scale"))
na_ip_pv_hn_scaled.pared <- predict(na_ip_pv_hn_pp.pared, na_ip_pv_hn_combined.pared)
notath_scaled.pared <- na_ip_pv_hn_scaled.pared %>% filter(dataset == "1") %>%
  mutate(body.index.notath = ((Nath.life.stage.pared$weight_mg/((Nath.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
pimvig_scaled.pared <- na_ip_pv_hn_scaled.pared %>% filter(dataset == "2") %>%
  mutate(body.index.pimvig = ((Pvig.life.stage.pared$weight_mg/((Pvig.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
ictpun_scaled.pared <- na_ip_pv_hn_scaled.pared %>% filter(dataset == "3") %>%
  mutate(body.index.ictpun = ((Ipun.life.stage.pared$weight_mg/((Ipun.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
hybnuc_scaled.pared <- na_ip_pv_hn_scaled.pared %>% filter(dataset == "4") %>%
  mutate(body.index.hybnuc = ((Hnuc.life.stage.pared$weight_mg/((Hnuc.life.stage.pared$standard_length_mm)^3)))*(100)) %>%
  janitor::clean_names()
```

### Plot FCF vs. total parasite burden (question 1)
```{r exploratory plots, echo=FALSE, eval=FALSE}

# plot condition factor vs parasite burden in total - may be interesting
IP.psc.fcf <- ggplot(Ipun.life.stage.total, 
       aes(x = psite_count, y = body_index_pun, colour = ci)) + geom_point() + xlab("Parasite Count")  + 
  ylab("FCF")  + theme_bw() + stat_smooth(method=lm)

NA.psc.fcf <- ggplot(Nath.life.stage.total, 
       aes(x = psite_count, y = body_index_ath, colour = ci)) + geom_point() + xlab("Parasite Count")  + 
  ylab("FCF")  + theme_bw() + stat_smooth(method=lm)

PV.psc.fcf <- ggplot(Pvig.life.stage.total, 
       aes(x = psite_count, y = body_index_vig, colour = ci)) + geom_point() + xlab("Parasite Count")  + 
  ylab("FCF")  + theme_bw() + stat_smooth(method=lm)

HN.psc.fcf <- ggplot(Hnuc.life.stage.total, 
       aes(x = psite_count, y = body_index_nuc, colour = ci)) + geom_point() + xlab("Parasite Count")  + 
  ylab("FCF")  + theme_bw() + stat_smooth(method=lm)

ggarrange(IP.psc.fcf, NA.psc.fcf, PV.psc.fcf, HN.psc.fcf, common.legend = TRUE, legend = "bottom", labels = c("A", "B", "C", "D"))
# more variability than the others

# Jolee's graph - messing around

```

### Plot life stage data using original dataframe (with above-mentioned exclusions) (to answer question 2)
```{r life stage plots, echo=TRUE}
# plot condition factor for life stage (aka "stage-specific parasite stuff")
NA.bc.a <- ggplot(Nath.life.stage.pared,
       aes(x = adult, y = body_index_ath, color = sex)) + xlab("Adult")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

NA.bc.l <- ggplot(Nath.life.stage.pared,
       aes(x = larval, y = body_index_ath, color = sex)) + xlab("Larval")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

# plot condition factor for life stage (aka "stage-specific parasite stuff")
IP.bc.a <- ggplot(Ipun.life.stage.pared,
       aes(x = adult, y = body_index_pun, color = sex)) + xlab("Adult")  + geom_point() + 
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

IP.bc.l <- ggplot(Ipun.life.stage.pared, 
       aes(x = larval, y = body_index_pun, color = sex)) + xlab("Larval")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

# plot condition factor for life stage (aka "stage-specific parasite stuff")
PV.bc.a <- ggplot(Pvig.life.stage.pared, 
       aes(x = adult, y = body_index_vig, color = sex)) + xlab("Adult")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

PV.bc.l <- ggplot(Pvig.life.stage.pared,
       aes(x = larval, y = body_index_vig, color = sex)) + xlab("Larval")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

# plot condition factor for life stage (aka "stage-specific parasite stuff")
HN.bc.a <- ggplot(Hnuc.life.stage.pared, 
       aes(x = adult, y = body_index_nuc, color = sex)) + xlab("Adult")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

HN.bc.l <- ggplot(Hnuc.life.stage.pared,
       aes(x = larval, y = body_index_nuc, color = sex)) + xlab("Larval")  + geom_point() +
  ylab("Fulton's Condition Factor")  + theme_bw() + stat_smooth(method=lm)

ggarrange(IP.bc.a, IP.bc.l, NA.bc.a, NA.bc.l, PV.bc.a, PV.bc.a, HN.bc.a, HN.bc.l, common.legend = TRUE, legend = "bottom", labels = c("A", "B", "C", "D", "E", "F", "G", "H"))
# more variability than the others

## double check sex, weights
## should we exclude these outliers

# Jolee's plot - messing around
ggplot(full.data.revised,
       aes(x = life_stage,
           y = fcf,
           colour = sex)) +
  geom_boxplot()

```
```{r, plots for Question 3}
# FCF ~ life_stage * taxon + psite_count (A: T vs C, L: T vs C)

# Jolee's plots - messing around
ggplot(full.data.revised %>%
         filter(psite_taxon != "CEST"),
       aes(x = life_stage,
           y = fcf,
           colour = psite_taxon,
           scale_colour_gradient(psite_count, low = "blue", high = "red", name = "Parasite Count"))) + # fix to add in psite_count possibly
  geom_boxplot() +
  xlab("Life Stage") +
  ylab("FCF") +
  labs(colour = "Parasite Taxon") +
  theme_bw()

```



## Models
We want to run a general linear model to test the research questions:
1. Is body condition associated with increased total parasite burden?
  - is there a linear association between increasing body condition and increasing parasite burden?
  - does FCF increase as parasite burden increases?
2. Is body condition associated with infection with adult or larval stages of parasites?
  - is there a linear association between increasing body condition and increasing abundance of larval or adult parasites in the host?
  - does FCF increase as adult or larval parasite presence increases?
  - variables: 
    - predictor = parasite_count, life_stage --> discrete
    - response = FCF --> continuous
  - discrete predictor = ANOVA
  - multiple/ continuous and discrete predictors = ANCOVA? 

#### Model formula for Question 1 
$$
K_i\sim parasite\ count
$$

#### Model formula for Question 2 (a and b) 
$$
K_i\sim\ life\ stage\ + parasite\ count
$$
#### Model formula for Question 3 
$$
K_i\sim\ life\ stage\ * taxon\ + parasite\ count\ + (1|fish)\ + (1|catelog) 
$$

#### Run linear model to test above questions
```{r model}

# Question 1 (lm)
summary(FCF_ath_lm <- lm(body_index_ath ~ psite_count, data = Nath.life.stage.total))
plot(FCF_ath_lm)

summary(FCF_ath_lm <- lm(body_index_pun ~ psite_count, data = Ipun.life.stage.total))
plot(FCF_ath_lm)

summary(FCF_ath_lm <- lm(body_index_vig ~ psite_count, data = Pvig.life.stage.total))
plot(FCF_ath_lm)

summary(FCF_nuc_lm <- lm(body_index_nuc ~ psite_count, data = Hnuc.life.stage.total))
plot(FCF_nuc_lm)

# Question 2 (lm)
summary(FCF_ath_al_lm <- lm(body_index_ath ~ larval + psite_count, data = Nath.life.stage.pared))
plot(FCF_ath_al_lm)

summary(FCF_ath_al_lm <- lm(body_index_pun ~ larval + psite_count, data = Ipun.life.stage.pared))
plot(FCF_ath_al_lm)

summary(FCF_ath_al_lm <- lm(body_index_vig ~ larval + psite_count, data = Pvig.life.stage.pared))
plot(FCF_ath_al_lm)

summary(FCF_nuc_al_lm <- lm(body_index_nuc ~ larval + psite_count, data = Hnuc.life.stage.pared))
plot(FCF_nuc_al_lm)

```

## Full dataset analyses

#### Import dataset 
- make sure you name all these new datasets and frames something different from what you named them above (that way we can still run all the analyses in total without losing any of the previous ones)
```{r full dataset import, echo=FALSE}
full.data <- read.csv("data/processed/Full_dataset_with_psite_life_history_info_2024.07.25.csv") %>% 
  janitor::clean_names() 
```

#### Mutate to change character to numeric for weight_mg
```{r mutate variable, echo=FALSE}
full.data <- full.data %>%
  mutate(weight_mg = as.numeric(weight_mg))
full.data <- full.data %>%
  mutate(psite_count = as.numeric(psite_count))

```

### Split everything into adult or larval based on the designations from initial analyses and create a column for identifying parasite taxonomic group. 
- acanths
- monogenes
- myxozoans 
Make sure you rename the new dataframe as something different from what you named it in the previous one (so that we can keep both versions to reference back to)
- need to readd acanths if we are using the percina data (acanth.cya)
### Remove from the dataframe the parasites that can only occur as either an adult or a larvae in the host. Add back a column for Fulton's Condition Factor.
```{r add stages to total, echo=FALSE}

full.data.stages <- full.data %>%
  mutate(
    life_stage = case_when(
      psite_count == 0 ~ "uninfected", 
      psite_spp_x %in% c("ACANTH.BIGB", "ACANTH.BKR", "NEM.CONA", "NEM.CAP",
                         "NEM.DICH", "NEM.LARV", "NEM.TRBK", "NEM.UNK",
                         "CEST.GODZ", "CEST.COMP", "CEST.NTG", "COPE.CL",
                         "COPE.GRAB", "CEST.PEA", "CEST.L", "CEST.VIT",
                         "CEST.UNK", "MONO.GYRO", "MONO.DACT", "MONO.LG",
                         "TREM.RNDA", "TREM.UNK", "ACAN.OSTR", "CEST.COMP",
                         "CEST.MEG", "LEECH.KUT", "NEM.NMTS", "MONO.IP",
                         "MONO.UNK", "NEM.PHAR", "NEM.PTY", "NEM.SP",
                         "NEM.TAF", "NEM.UNK", "NMORPH", "TREM.2",
                         "TREM.ALLO", "TREM.BLE", "TREM.CREP", "TREM.F",
                         "TREM.LIP", "TREM.MEGICT", "TREM.SMILE", "TREM.UNK",
                         "CEST.COMP", "CEST.HYD", "CEST.LVS", "CEST.TRI",
                         "COPE.A", "MONO.ALL", "MONO.UNK", "NEM.BRAN",
                         "NEM.CAP", "NEM.SPKY", "NEM.TFS", "NEM.TWAS",
                         "NEM.UNKN", "TREM.GB", "TREM.L", "CEST.BB",
                         "NEM.BUD", "NEM.UNK", "TREM.ASS", "TREM.NS",
                         "TREM.DIPLO", "TREM.UNK", "CEST.UNK", "MONO.DACT",
                         "MONO.GDAC", "ACAN.AD", "COPE.POOD") ~ "adult",
      
      psite_spp_x %in% c("META.HS", "META.UNK", "MYX.GO", "MYX.GEOM",
                         "MYXO.BC", "MYX.THEL", "MYXO.SBAD", "MYXO.UNK",
                         "MYXO.UP", "TREM.MET", "TREM.SSS", "TREM.BUC",
                         "TREM.METAF", "TREM.METAGS", "TREM.MS", "TREM.NEA",
                         "NEM.CYST", "TREM.META.GG", "TREM.META.UNK", "TREM.LG",
                         "MYX.TAIL", "MYX.GEOM", "NEM.CYST", "NEM.DAFT",
                         "TREM.CM", "TREM.META.HET", "TREM.META.SP", "TREM.BC",
                         "TREM.META.GO", "TREM.META.ES", "MYX.AK", "MYX.FI",
                         "MYX.TIN", "MYX.GL", "MYX.OT", "MYX.EYE",
                         "MYX.GC", "NEM.CYST", "TREM.LARV", "TREM.META",
                         "MYX.SP", "MYX.ROUND", "TREM.CYST") ~ "larval",
      
      is.na(psite_spp_x) ~ "0"
    ),
    
    psite_taxon = case_when(
      psite_count == 0 ~ "uninfected",  
      startsWith(psite_spp_x, "CEST") ~ "cest",
      startsWith(psite_spp_x, "TREM") ~ "trem",
      startsWith(psite_spp_x, "META") ~ "trem",
      startsWith(psite_spp_x, "NEM") ~ "nem",
      TRUE ~ "other"
    )
  ) %>%
  filter(!str_detect(psite_spp_x, "^(ACAN|MONO|COPE|LEECH|NMORPH|MYX)")) %>%
  replace_na(list(life_stage = "uninfected"))  %>%
  janitor::clean_names()


### FCF added back
full.data.stages <- full.data.stages %>%
  mutate(FCF = ((full.data.stages$weight_mg/((full.data.stages$standard_length_mm)^3)))*(100)) %>% 
  janitor::clean_names()

### fix variable type
full.data.stages <- full.data.stages %>%
  mutate(life_stage = as.factor(life_stage))
full.data.stages <- full.data.stages %>%
  mutate(psite_taxon = as.factor(psite_taxon))

```

### Plot relationships for total data models


### Test the model for question 3

```{r model for q3}
#<<<<<<< HEAD
summary(q3m <- lm(fcf ~ life_stage * psite_taxon + psite_count, data = full.data.revised))
plot(q3m)
        
```
Steps to Improve the Model
Check for Multicollinearity:
-Multicollinearity can cause instability in the coefficient estimates. You can use the Variance Inflation Factor (VIF) to check for this.
Transform Variables:
-Transforming the dependent variable (fcf) or the independent variables might help in stabilizing variance and making the model fit better.
Remove or Address Outliers:
-Identify and address outliers that might be affecting the model fit.
Interaction Terms:
-Simplify or reconsider interaction terms if they are not significant or cause issues.
Robust Regression:
-Use robust regression techniques to handle outliers better.

```{r}

#Step 1: Check for Multicollinearity
# Load necessary package
if (!require(car)) install.packages("car")
library(car)

# Check for aliased coefficients
alias(lm(fcf ~ life_stage * psite_taxon + psite_count, data = full.data.revised))

# Load necessary package
install.packages("glmnet")
library(glmnet)

# Prepare data for ridge regression
x <- model.matrix(fcf ~ life_stage * psite_taxon + psite_count, data = full.data.revised)[, -1]
y <- full.data.revised$fcf

# Fit ridge regression model
ridge_model <- cv.glmnet(x, y, alpha = 0)
summary(ridge_model)


# Calculate VIF
vif(lm(fcf ~ life_stage * psite_taxon + psite_count, data = full.data.revised, type="predictor"))
#A VIF value greater than 5-10 indicates high multicollinearity.

#Step 2: Transform Variables
#Consider a log transformation of fcf if it is highly skewed:
# Transform the dependent variable
full.data.revised$log_fcf <- log(full.data.revised$fcf + 1) # Adding 1 to avoid log(0)

# Fit the model again
q3m2_ancova_log <- lm(log_fcf ~ psite_count + life_stage * psite_taxon, data = full.data.revised)
summary(q3m2_ancova_log)
#Step 3: Identify and Address Outliers
# Cook's distance to identify influential points
cooksd <- cooks.distance(q3m2_ancova)
plot(cooksd, type = "h", main = "Cook's Distance", ylab = "Cook's distance")
abline(h = 4/(nrow(full.data.revised)-length(coef(q3m2_ancova))), col = "red")

# Remove influential points
influential_points <- which(cooksd > (4/(nrow(full.data.revised) - length(coef(q3m2_ancova)))))
full.data.cleaned <- full.data.revised[-influential_points, ]

# Fit the model again without influential points
q3m2_ancova_cleaned <- lm(fcf ~ psite_count + life_stage * psite_taxon, data = full.data.cleaned)
summary(q3m2_ancova_cleaned)
#Step 4: Simplify Interaction Terms
#If an interaction term is not significant or causing issues, consider removing it:
# Fit a simplified model without the problematic interaction term
q3m2_ancova_simple <- lm(fcf ~ psite_count + life_stage + psite_taxon, data = full.data.revised)
summary(q3m2_ancova_simple)
#Step 5: Robust Regression
# Load necessary package
if (!require(MASS)) install.packages("MASS")
library(MASS)

# Fit a robust regression model
q3m2_robust <- rlm(fcf ~ psite_count + life_stage * psite_taxon, data = full.data.revised)
summary(q3m2_robust)
#=======

#### I think this is the model that we should go with, which is finally maybe fully working? check with DAki's model diagnostics stuff
summary(q3m <- lmer(fcf ~ life_stage + psite_taxon + psite_count + (1|fish_sp_x) + (1|catalog_number), data = full.data.stages))

# check colinearity using vif function --> less than 10 means model is ok concerning colinearity
vif(q3m)

# check how the different variables are interacting with each other 

crosstab <- full.data.stages %>%
  count(life_stage, psite_taxon, psite_count)
crosstab_table <- crosstab %>%
  pivot_wider(names_from = psite_count, values_from = n, values_fill = list(n = 0))
view(crosstab_table)

# Print the table
print(kable(crosstab_table, format = "markdown"))



ggplot(crosstab, aes(x = life_stage, y = psite_taxon, fill = n)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(x = "Variable 1", y = "Variable 2", fill = "Count") +
  facet_wrap(~ psite_count) +
  theme_minimal()


#Evaluate diagnostics
library(DHARMa)
library(MASS)
>>>>>>> 352050d06b050ab220e21975f7b890bb959fd427

s=simulateResiduals(fittedModel=q3m,n=250)
s$scaledResiduals
plot(s)

```
<<<<<<< HEAD
Explanation
Multicollinearity: By calculating VIF, you can identify if any predictors are highly correlated and address them by removing or combining variables.
Transformation: Transforming fcf can help in stabilizing variance and normalizing the distribution.
Outliers: Identifying and removing influential points can improve the model's fit.
Simplifying Interaction Terms: If the interaction terms are not significant or causing issues, removing them can simplify the model and improve interpretability.
Robust Regression: Using robust regression can provide more reliable estimates in the presence of outliers.


=======
>>>>>>> 352050d06b050ab220e21975f7b890bb959fd427

